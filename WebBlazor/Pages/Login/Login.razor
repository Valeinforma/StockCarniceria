@page "/login"
@inject FirebaseAuthService _firebaseAuthService
@inject SweetAlertService _sweetAlert
@inject NavigationManager _navigationManager

<PageTitle>Iniciar Sesión - StockCarniceria</PageTitle>

@if (!isAuthenticated)
{
    <!-- VISTA: INICIAR SESIÓN -->
    <div class="d-flex justify-content-center align-items-center" style="min-height: calc(100vh - 70px); padding: 2rem 0;">
        <div class="card text-center shadow-lg" style="max-width: 450px; width: 100%;">
            <div class="card-header bg-primary text-white">
                Iniciar sesión
            </div>
            <div class="card-body">
                <h3 class="card-title mb-4">Bienvenido a StockCarniceria</h3>
                <div class="form-group mb-3">
                    <label class="form-label fw-bold">Correo electrónico:</label>
                    <InputText class="form-control" @bind-Value="email" placeholder="usuario@gmail.com" />
                </div>

                <div class="form-group mb-4">
                    <label class="form-label fw-bold">Contraseña:</label>
                    <InputText class="form-control" @bind-Value="password" placeholder="Contraseña" type="password" />
                </div>

                <div class="form-group mb-4">
                    <div class="form-check text-start">
                        <InputCheckbox class="form-check-input" id="rememberCheck" @bind-Value="rememberPassword" />
                        <label class="form-check-label" for="rememberCheck">Recordar contraseña</label>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-success" @onclick="Loguear">Acceder</button>
                    <button class="btn btn-outline-secondary" @onclick="RegisterMe">Registrarme</button>
                    <button class="btn btn-outline-danger" @onclick="LoginWithGoogle">
                        <span class="bi bi-google me-2"></span> Google
                    </button>
                </div>
            </div>
            <div class="card-footer text-muted small">
                Desarrollo 2do año - TSDS - 2025
            </div>
        </div>
    </div>
}
else
{
    <!-- VISTA: CERRAR SESIÓN -->
    <div class="d-flex justify-content-center align-items-center" style="min-height: calc(100vh - 70px);">
        <div class="card text-center shadow-lg" style="max-width: 450px; width: 100%;">
            <div class="card-header bg-danger text-white">
                Sesión Activa
            </div>
            <div class="card-body">
                <p class="card-text mb-4">Actualmente has iniciado sesión en StockCarniceria.</p>
                <button class="btn btn-danger" @onclick="Desloguear">Cerrar sesión</button>
            </div>
            <div class="card-footer text-muted small">
                Desarrollo 2do año - TSDS - 2025
            </div>
        </div>
    </div>
}

@code {
    bool isAuthenticated = false;
    string email = string.Empty;
    string password = string.Empty;
    bool rememberPassword = false;

    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await _firebaseAuthService.IsUserAuthenticated();
    }

    private async Task Loguear()
    {
        var user = await _firebaseAuthService.SignInWithEmailPassword(email, password, rememberPassword);
        if (user is not null)
        {
            if (user.EmailVerified == false)
            {
                await _sweetAlert.FireAsync(new SweetAlertOptions
                {
                    Icon = SweetAlertIcon.Warning,
                    Title = "Verificación de correo",
                    Text = "Por favor, verifica tu correo electrónico antes de iniciar sesión."
                });
                return;
            }
            isAuthenticated = true;
            StateHasChanged();
            _navigationManager.NavigateTo("/");
        }
        else
        {
            await _sweetAlert.FireAsync(new SweetAlertOptions
            {
                Icon = SweetAlertIcon.Error,
                Title = "Error de autenticación",
                Text = "Correo o contraseña incorrectos."
            });
        }
    }

    private async Task Desloguear()
    {
        await _firebaseAuthService.SignOut();
        isAuthenticated = false;
        email = string.Empty;
        password = string.Empty;
        StateHasChanged();
    }

    private void RegisterMe()
    {
        _navigationManager.NavigateTo("/signin");
    }

    private async Task LoginWithGoogle()
    {
        var user = await _firebaseAuthService.LoginWithGoogle();
        if (user is not null)
        {
            isAuthenticated = true;
            StateHasChanged();
            _navigationManager.NavigateTo("/");
        }
        else
        {
            await _sweetAlert.FireAsync(new SweetAlertOptions
            {
                Icon = SweetAlertIcon.Error,
                Title = "Error de autenticación",
                Text = "No se pudo iniciar sesión con Google."
            });
        }
    }
}