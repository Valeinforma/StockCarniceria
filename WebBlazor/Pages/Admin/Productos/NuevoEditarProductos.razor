@page "/nuevoEditarProducto"

@using Service.Models
@using Service.Services
@using CurrieTechnologies.Razor.SweetAlert2

@inject NavigationManager NavigationManager
@inject IGenericService<Producto> _productoService
@inject IGenericService<Categoria> CategoriaService
@inject IGenericService<Proveedor> ProveedorService
@inject SweetAlertService sweetAlert

@if (producto is null || ListaCategorias is null || ListaProveedores is null)
{
    <p><em>Cargando @(isEditing ? "producto para editar" : "formulario")...</em></p>
}
else
{
    <div class="card shadow-lg p-3">
        <h3 class="card-header bg-primary text-white text-center">@tituloPagina</h3>
        <div class="card-body">
            <div style="background-color: @(isEditing ? "#f8f9fa" : "white"); padding: 1rem; border-radius: 8px;">
                <EditForm Model="producto" OnValidSubmit="Guardar">
                    <DataAnnotationsValidator />
                    <div class="container">
                        <div class="row g-3">
                            <!-- Columna de 6 para los campos principales -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-bold">Nombre:</label>
                                    <InputText class="form-control mb-2" @bind-Value="producto.Nombre" />
                                    <ValidationMessage For="@(() => producto.Nombre)" />
                                </div>
                                <div class="form-group">
                                    <label class="form-label fw-bold">Precio Unitario:</label>
                                    <InputNumber class="form-control mb-2" @bind-Value="producto.PrecioUnitario" />
                                    <ValidationMessage For="@(() => producto.PrecioUnitario)" />
                                </div>
                                <div class="form-group">
                                    <label class="form-label fw-bold">Stock:</label>
                                    <InputNumber class="form-control mb-2" @bind-Value="producto.Stock" />
                                    <ValidationMessage For="@(() => producto.Stock)" />
                                </div>
                            </div>
                            <!-- Columna de 6 para los campos secundarios -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-bold">Unidad (ej: kg, ud):</label>
                                    <InputText class="form-control mb-2" @bind-Value="producto.Unidad" />
                                    <ValidationMessage For="@(() => producto.Unidad)" />
                                </div>

                                <!-- Selector de Categoría -->
                                <div class="form-group">
                                    <label class="form-label fw-bold">Categoría:</label>
                                    <InputSelect id="categoria" @bind-Value="producto.CategoriaId" class="form-select mb-2" @onchange="OnCategoryChange">
                                        <option value="0">-- Seleccione una Categoría --</option>
                                        @if (ListaCategorias != null)
                                        {
                                            @foreach (var cat in ListaCategorias)
                                            {
                                                <option value="@cat.Id">@cat.Nombre</option>
                                            }
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => producto.CategoriaId)" />
                                </div>

                                <!-- Selector de Proveedor -->
                                <div class="form-group">
                                    <label class="form-label fw-bold">Proveedor:</label>
                                    <InputSelect id="proveedor" @bind-Value="producto.ProveedorId" class="form-select mb-2" @onchange="OnSupplierChange">
                                        <option value="0">-- Seleccione un Proveedor --</option>
                                        @if (ListaProveedores != null)
                                        {
                                            @foreach (var prov in ListaProveedores)
                                            {
                                                <option value="@prov.Id">@prov.Nombre</option>
                                            }
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => producto.ProveedorId)" />
                                </div>
                            </div>
                        </div>

                        <ValidationSummary class="alert alert-warning mt-3" />

                        <div class="mt-4">
                            <button class="btn btn-primary me-2" type="submit" disabled="@isSaving">
                                <i class="oi oi-check"></i> @guardarButtonText
                            </button>
                            <button class="btn btn-danger" type="button" @onclick="Cancelar" disabled="@isSaving">
                                <i class="oi oi-x"></i> Cancelar
                            </button>
                        </div>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery]
    [Parameter]
    public int? idProducto { get; set; }

    private Producto? producto;
    private List<Categoria>? ListaCategorias;
    private List<Proveedor>? ListaProveedores;
    private bool isSaving = false;

    private bool isEditing => idProducto.HasValue && idProducto.Value > 0;
    private string guardarButtonText => isEditing ? "Actualizar" : "Agregar";
    private string tituloPagina => isEditing ? "Editando Producto" : "Agregando nuevo Producto";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Cargar listas de categorías y proveedores
            ListaCategorias = (await CategoriaService.GetAllAsync())?.ToList();
            ListaProveedores = (await ProveedorService.GetAllAsync())?.ToList();

            if (isEditing)
            {
                producto = await _productoService.GetByIdAsync((int)idProducto!);

                if (producto != null)
                {
                    // Sincronizar IDs si las relaciones existen
                    if (producto.Categoria != null)
                    {
                        producto.CategoriaId = producto.Categoria.Id;
                    }
                    if (producto.Proveedor != null)
                    {
                        producto.ProveedorId = producto.Proveedor.Id;
                    }
                }
            }
            else
            {
                // Inicializar nuevo producto con relaciones vacías
                producto = new Producto
                {
                    Categoria = null,
                    Proveedor = null,
                    CategoriaId = 0,
                    ProveedorId = 0
                };
            }
        }
        catch (Exception ex)
        {
            await sweetAlert.FireAsync("Error", $"No se pudo cargar el producto: {ex.Message}", SweetAlertIcon.Error);
        }
    }

    private void OnCategoryChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int selectedId))
        {
            producto!.CategoriaId = selectedId;
        }
    }

    private void OnSupplierChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int selectedId))
        {
            producto!.ProveedorId = selectedId;
        }
    }

    private async Task Guardar()
    {
        try
        {
            isSaving = true;

            // Validar que producto no sea null
            if (producto == null)
            {
                await sweetAlert.FireAsync("Error", "El producto no puede ser nulo.", SweetAlertIcon.Error);
                return;
            }

            // Validar que se hayan seleccionado categoría y proveedor
            if (producto.CategoriaId == 0 || producto.ProveedorId == 0)
            {
                await sweetAlert.FireAsync("Validación", "Por favor, selecciona una Categoría y un Proveedor válidos.", SweetAlertIcon.Warning);
                isSaving = false;
                return;
            }

            // Crear una copia para enviar sin objetos de navegación
            var productoParaGuardar = new Producto
            {
                Id = producto.Id,
                Nombre = producto.Nombre,
                PrecioUnitario = producto.PrecioUnitario,
                Stock = producto.Stock,
                Unidad = producto.Unidad,
                CategoriaId = producto.CategoriaId,
                ProveedorId = producto.ProveedorId,
                Categoria = null,
                Proveedor = null
            };

            if (isEditing)
            {
                await _productoService.UpdateAsync(productoParaGuardar);
                await sweetAlert.FireAsync("Éxito", $"El producto '{productoParaGuardar.Nombre}' ha sido actualizado correctamente.", SweetAlertIcon.Success);
            }
            else
            {
                await _productoService.AddAsync(productoParaGuardar);
                await sweetAlert.FireAsync("Éxito", $"El producto '{productoParaGuardar.Nombre}' ha sido creado correctamente.", SweetAlertIcon.Success);
            }

            NavigationManager.NavigateTo("productos");
        }
        catch (Exception ex)
        {
            await sweetAlert.FireAsync("Error al guardar", ex.Message, SweetAlertIcon.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancelar()
    {
        NavigationManager.NavigateTo("/productos");
    }
}